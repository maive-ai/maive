{
  "classes": [
    {
      "label": "missing_additional_service_or_component",
      "title": "Missing Additional Service or Component",
      "description": "An additional service, component, or work item was discussed and explicitly agreed upon in the conversation but is absent from the estimate. Examples: replacing pipe boots, plywood, installing ridge vents, replacing valley flashing, gutters work, chimney flashing, skylight work, or any add-on service that was promised but not documented."
    },
    {
      "label": "missing_material_specification",
      "title": "Missing Material Specification",
      "description": "A specific roofing material (shingle type, brand, color, style, or quality grade) was discussed in the conversation but is not documented in the estimate or form. Examples: 'We'll use GAF Timberline HDZ shingles' but estimate shows generic shingles; customer chose 'Charcoal' color but color not specified in documentation."
    },
    {
      "label": "missing_discount",
      "title": "Missing Discount",
      "description": "The sales rep applied a discount or promotional offer during the conversation but it is not formally documented in the estimate or contract. Examples: promised percentage off not shown in estimate; early bird discount mentioned but not recorded; referral discount applied verbally but missing from documentation."
    },
    {
      "label": "missing_special_request",
      "title": "Missing Special Customer Request",
      "description": "A specific customer request, preference, or special instruction discussed in the conversation is not captured in the notes to production or estimate. Examples: 'work only on weekdays'; 'avoid blocking driveway'; 'protect specific landscaping'; 'notify before arrival'; access restrictions; pet considerations; using a specific type of material (e.g. marine-grade plywood)."
    },
    {
      "label": "scope_area_discrepancy",
      "title": "Work Scope or Area Discrepancy",
      "description": "The physical scope or area of work discussed differs from documentation. Examples: discussed doing entire house but estimate only covers front; garage or shed roofing mentioned but not included; number of roof sections differs from discussion; square footage discrepancy."
    },
    {
      "label": "missing_damage_repair",
      "title": "Missing Damage Repair",
      "description": "The sales rep identified existing damage (wood rot, deck damage, fascia damage, soffit damage) during the conversation and discussed repairing it, but this repair work is not included in the estimate. This includes any structural repairs that need to happen before or during the roofing work."
    }
  ],
  "output_schema": {
    "description": "The expected output format when an LLM classifies deviations",
    "type": "object",
    "properties": {
      "deviations": {
        "type": "array",
        "description": "List of all deviations found between the conversation and documented data",
        "items": {
          "type": "object",
          "properties": {
            "deviation_class": {
              "type": "string",
              "description": "The label of the deviation class from the classes list above",
              "enum": [
                "missing_additional_service_or_component",
                "missing_material_specification",
                "missing_discount",
                "missing_special_request",
                "scope_area_discrepancy",
                "missing_damage_repair"
              ]
            },
            "explanation": {
              "type": "string",
              "description": "A brief explanation of what specific deviation was found (e.g., 'Customer requested GAF Timberline HDZ shingles in Charcoal but estimate does not specify shingle brand or color'). Be concise."
            },
            "occurrences": {
              "type": "array",
              "description": "List of specific timestamps where this deviation was mentioned in the conversation(s)",
              "items": {
                "type": "object",
                "properties": {
                  "rilla_conversation_index": {
                    "type": "integer",
                    "description": "Zero-based index into the list of Rilla conversations (0 for first conversation, 1 for second, etc.)"
                  },
                  "timestamp": {
                    "type": "string",
                    "description": "Timestamp in HH:MM:SS format when this deviation was mentioned in the conversation",
                    "pattern": "^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$"
                  }
                },
                "required": ["rilla_conversation_index", "timestamp"]
              }
            }
          },
          "required": ["deviation_class", "explanation", "occurrences"]
        }
      },
      "summary": {
        "type": "string",
        "description": "Brief overall summary of findings (e.g., 'Found 3 deviations: material specifications, additional services, and special requests not documented')"
      }
    },
    "required": ["deviations", "summary"]
  }
}
