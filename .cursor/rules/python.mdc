---
globs: */**/*.py
alwaysApply: false
---
You are an expert in Python and scalable API development.

UV
- We use uv as our virtual environment manager. Use 'uv run python' to invoke python.

Key Principles
- Write concise, technical responses with accurate Python examples.
- Prefer iteration and modularization over code duplication.
- Use descriptive variable names with auxiliary verbs (e.g., is_active, has_permission).
- Use lowercase with underscores for directories and file
- Favor named exports for routes and utility functions.
- Use the Receive an Object, Return an Object (RORO) pattern.

Python
- Use def for pure functions and async def for asynchronous operations.
- Use typing everywhere.
- Prefer Pydantic models over raw dictionaries for input validation.
- Avoid unnecessary curly braces in conditional statements.
- For single-line statements in conditionals, omit curly braces.
- Use concise, one-line syntax for simple conditional statements (e.g., if condition: do_something()).
- Use enums instead of string comparisons
- Minimize indentation where possible through the early-return idiom

Imports
- All imports must be at the top of the file, immediately after the module docstring
- Never place imports inside functions, methods, or conditional blocks
- Group imports in this order:
  1. Standard library imports (e.g., `import asyncio`, `from datetime import datetime`)
  2. Third-party imports (e.g., `from fastapi import APIRouter`, `from pydantic import BaseModel`)
  3. Local imports (e.g., `from src.auth import ...`, `from src.db import ...`)
- Within each group, sort alphabetically
- Separate each group with a blank line

Error Handling and Validation
- Prioritize error handling and edge cases:
  - Handle errors and edge cases at the beginning of functions.
  - Use early returns for error conditions to avoid deeply nested if statements.
  - Place the happy path last in the function for improved readability.
  - Avoid unnecessary else statements; use the if-return pattern instead.
  - Use guard clauses to handle preconditions and invalid states early.
  - Implement proper error logging and user-friendly error messages.
  - Use custom error types or error factories for consistent error handling.

OpenAPI Client Generation
- After adding/modifying FastAPI endpoints, regenerate the TypeScript client: `./scripts/sync-api-client.sh`
- This ensures frontend has type-safe access to all backend APIs

Logging
- Use structured logging with keyword arguments instead of f-strings
- Prefix all log messages with `[MODULE]` or `[COMPONENT]` to identify the source at a glance
- Good: `logger.info("[AUTH] User logged in", user_id=user.id, email=user.email)`
- Bad: `logger.info(f"User {user.id} logged in with email {user.email}")`
- Structured logs enable better CloudWatch Insights queries and log analysis
- Keep log messages as simple descriptive labels, put all data in keyword arguments
- Example prefixes: `[AGENT]`, `[MCP]`, `[WEB_SEARCH]`, `[FILE_SEARCH]`, `[AUTH]`, `[CRM]`, `[STREAM]`
- Example patterns:
  - `logger.info("[USER_INPUT]", user_id=str(user_id), input=message)`
  - `logger.info("[MCP] Tool call started", item_id=item_id)`
  - `logger.error("[AUTH] Login failed", user_id=user_id, error=str(e))`
- Never use reserved `LogRecord` attributes as keyword arguments: `filename`, `message`, `name`, `pathname`, `lineno`, `levelname`, `funcName`, `module`, `thread`, `process`, `asctime`. Use alternatives like: `file_name`, `error_message`, `store_name` instead
